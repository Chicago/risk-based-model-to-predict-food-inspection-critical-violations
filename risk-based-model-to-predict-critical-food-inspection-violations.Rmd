---
title: "A risk-based model to predict critical food inspection violations"
author: 
  - Tom Schenk Jr. (City of Chicago)
  - Gene Leynes (City of Chicago)
  - Aakash Solanki (City of Chicago)
  - Stephen Collins (Allstate Insurance)
  - Gavin Smart (Allstate Insurance)
  - Ben Albright (Allstate Insurance)
  - David Crippin (Allstate Insurance)
  - Raed Mansour (City of Chicago)
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: |
  The Chicago Department of Public Health (CDPH) inspects more than 15,000 restaurants with fewer than three dozen sanitarians over the course of the year. This paper describes a predictive model designed to identify the presence of a critical violation in a particular food establishment. The goal of this model is to prioritize inspections by likelihood in order to identify the riskiest restaurants earlier, thereby reducing the length of exposure of risky restaurants to patrons. Critical violations were identified approximately `r sprintf("%0.2f", mean(time_diff))` days earlier over a 60 day period compared to current operations in the out-of-sample test.
output:
  html_document:
    css: ../assets/journal-chicago/css/journal-chicago.css
    number_sections: yes
  pdf_document:
    number_sections: yes
  word_document: default
bibliography: references.bib
---


```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
##==============================================================================
## INITIALIZE
##==============================================================================
# if(interactive()){
#     ## Remove all objects; perform garbage collection
#     rm(list=ls())
#     gc(reset=TRUE)
#     geneorama::detach_nonstandard_packages()
# }
geneorama::loadinstall_libraries(c("data.table", "glmnet", "ggplot2", "knitr",
                                   "splines", "reportr", "scales", "knitcitations"))

## Define melt to be the data.table melt
melt <- data.table:::melt.data.table

```

```{r, echo=FALSE, results='hide', fig.show='hide', message=FALSE, warning=FALSE}
##==============================================================================
## RUN GLMNET MODEL
##==============================================================================

## NOTE: THE DIRECTORY NAME BELOW MUST MATCH YOUR PROECT DIRECTORY NAME
## If you clone the project directly from github.com the project name will
## automatically be food-inspection-evaluation, but if you change the name 
## you will need to update the name of the project below in the set_project_dir
## function below.
geneorama::set_project_dir("food-inspections-evaluation")
geneorama::sourceDir("CODE/functions/")

## Reads-in BibTex generated by Zotero library "Food Inspections"
biblio <- read.bibtex("references.bib")
options("citation_format" = "pandoc")

## Overwrite the base "interactive" function to prevent complete initialization
interactive <- function(){FALSE}
## Source the file that runs the glmnet model:
source("CODE/30_glmnet_model.R", echo = FALSE)
## Remove the temporary local "interactive" function
rm(interactive)
## Remove excess variables generated by "CODE/30_glmnet_model.R"
rm(confusion_values_test, dat, errors, errorsTest, iiTest, iiTrain, 
   lam, mm, pen, w.lam, xmat)

## These should be the only remaining objects (besides functions) imported:
# coef
# inspCoef
# datTest
# model

## List objects (besides functions) to check with comments above:
geneorama::lll()

## Load Food Inspection Data
food <- readRDS("DATA/food_inspections.Rds")
```


```{r, echo=FALSE}
## Set global knitr option to NOT echo code
opts_chunk$set(echo = FALSE)
```


```{r, results='hide'}
##==============================================================================
## DEFINE CUSTOM GGPLOT FUNCTION
##==============================================================================

# cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
#                "#0072B2", "#D55E00", "#CC79A7")

ggplot <- function(...) {
    cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
    ggplot2::ggplot(...) +
        theme_grey()+
        scale_fill_manual(values=cbPalette) +
        scale_colour_manual(values=cbPalette)
        # + theme(plot.title = element_text(size = 20))
    
}
```

```{r, results='hide'}
# cbPalette <- c("#000000", "#E69F00", "#56B4E9", 
#                "#009E73", "#F0E442", "#0072B2", 
#                "#D55E00", "#CC79A7")
# pie(rep(1,length(cbPalette)), col = cbPalette)
```

```{r, results='hide'}
comp <- cbind(
    datTest[i = order(Inspection_Date), 
            j = list(Inspection_ID_BAU   = Inspection_ID,
                     Inspection_Date   = Inspection_Date,
                     criticalFound_BAU     = criticalFound)],
    datTest[i = order(-glm_pred), 
            j = list(Inspection_ID_Model   = Inspection_ID,
                     criticalFound_Model   = criticalFound)])
comp <- comp[ , Best_Possible := criticalFound_Model[order(-criticalFound_Model)]]
comp <- comp[ , Worst_Possible := criticalFound_Model[order(criticalFound_Model)]]

comp_summary <- comp[
    i = TRUE, 
    j = list(Total_Inspections = .N,
             Crit_Violations_BAU = sum(criticalFound_BAU),
             Crit_Violations_Model = sum(criticalFound_Model),
             Best_Possible = sum(Best_Possible),
             Worst_Possible = sum(Worst_Possible)), 
    keyby = list(Inspection_Date = Inspection_Date)]
```

```{r prepare_calc_for_difference}
date_comp <- merge(
    x = comp[i = TRUE,
             j = list (criticalFound_BAU,
                       date_bau = Inspection_Date),
             keyby = list(id = Inspection_ID_BAU)],
    y = comp[i = TRUE,
             j = list (criticalFound_Model,
                       date_model = Inspection_Date),
             keyby = list(id = Inspection_ID_Model)],
    by = "id")

# Store this data as a variable to be used in text
time_diff <- date_comp[criticalFound_Model==1, -(date_model - date_bau)]
```
```{r calculate_violation_rates}
# datTest[period==1, list(.N, sum(criticalFound))]
# datTest[period_modeled==1, list(.N, sum(criticalFound))]

crit_viol_rate <- data.table(
    Regime = c("Business\nAs Usual", 
               "Data\nDriven"),
    values = c(datTest[period==1, sum(criticalFound)/.N],
               datTest[period_modeled==1, sum(criticalFound)/.N]))
crit_viol_cumulative <- data.table(
    Regime = c("Business\nAs Usual", 
               "Data\nDriven"),
    values = c(datTest[period==1, sum(criticalFound)] / datTest[ , sum(criticalFound)],
               datTest[period_modeled==1, sum(criticalFound)] / datTest[ , sum(criticalFound)]))
```

```{r, results='hide'}
## These are the calculations to support the rounded numbers in the introduction

## Total inspections by Risk
food[year(Inspection_Date)==2014 & grepl("Risk", Risk), .N, keyby=Risk]
food[year(Inspection_Date)==2014 & grepl("Risk", Risk), .N, keyby=Risk][,sum(N)]
## Licenses inspected by Risk
food[year(Inspection_Date)==2014 & grepl("Risk", Risk), .N,list(License, Risk)][
    i=TRUE, .N, keyby=Risk]
food[year(Inspection_Date)==2014 & grepl("Risk", Risk), .N,list(License, Risk)][
    i=TRUE, .N, keyby=Risk][,sum(N)]
```

```{r}
## Tables used in discussion of inspection types

geneorama::set_project_dir("food-inspections-evaluation")
source("CODE/functions/categorize.R")
# food[year(Inspection_Date)==2014,.N,Inspection_Type][order(-N)]
insp_types_2014 <- food[year(Inspection_Date)==2014, list(Inspection_Type)]
# insp_types_2014
insp_types_primary <- c("canvas", "canvas Re-Inspection", 
                           "License", "License Re-Inspection",
                           "Complaint", "Short Form Complaint",
                           "Complaint Re-Inspection")
insp_types_2014 <- insp_types_2014[
    i = TRUE , 
    j = Inspection_Type := categorize(x = Inspection_Type, 
                                      primary = insp_types_primary)]
```


```{r}
## Tables used in discussion of risk types

risk_2014 <- food[year(Inspection_Date)==2014 & grepl("Risk", Risk),
     .N,list(License, Risk)]
risk_2014_table <- rbind(risk_2014[,.N,keyby=Risk], 
                         data.table(Risk = "TOTAL", 
                                    N = nrow(risk_2014)))
risk_2014_table_formatted <- risk_2014_table[
    i = TRUE, 
    j = list(`Risk Category` = Risk, 
             `Count of Licenses` = geneorama::comma(N))]

```

# Introduction

Food safety and inspection programs are an important function for local governments to maintain the quality of health for residents and visitors while also protecting the perception of safety for restaurant patrons. Inspecting food establishments that are open to the public is becoming especially more important as over half of the United States population consume meals at a restaurant at least once a week. U.S. Department of Commerce has also reported that expenditures on dining now outpaces groceries. Likewise, the increasing population of on-demand courior services that deliver meals from restaurants to homes.

The Center for Disease Control estimates that 48 million individuals contract a foodborne illness, leading up to 3,000 fatalities. Between \$3.3 and \$14 billion is lost from foodborne diseases and approximately 61,000 quality-adjusted life years (QALY) each year `r citep(biblio["hoffmann_annual_2012"])`. While foodborne illnesses can be introduced at various parts in the food chain before it reaches restaurants, they are often suffer significant consequences as a result. When a large outbreak is encountered, the average economic consequence costs $100,000 in lost businesses, wages, and various health and legal fees `r citep(biblio["grover_hepatitis_2000"])`. 

Food safety is especially important for patrons who are susceptible to any infection, such as the elderly, pregnent, or with a weakend immune system. In the United States, a fifth of the population are particuarly susceptible to foodborne illnesses `r citep(biblio["smith_foodborne_1999"])`. Not surprisingly, a majority of patrons consider food safety to be important when deciding to eat meals at a restaurant. Patrons most frequently cite the perceived cleanliness as the deciding factor when assessing the food safety for a restaurant.

Local governments have the primary responsibility to inspect and enforce sanitation laws. Yet, as restaurants grow more popular, they face an increasing workload to ensure the safety of all food establishments in their jurisdiction. For instance in 2014, the Chicago Department of Public Health  performed over 20,000 inspections at nearly 13,000 food establishments across Chicago with fewer than three dozen sanitarians.

Fifteen percent of the typical, "canvas" inspections yielded a failure. Failures were uniformally distributed over the year with approximately a quarter of failures found every three months. Yet, the longer a restaurant with unsanitary food practices goes uninspected, the greater the likelihood that a patron contracts a foodborne illness. While Chicago must conduct all required food violations, the order in which sanitarians are conducted can impact the overall safety and efficiency of food safety inspections.

The model set forth in this paper can help with the prioritization of scheduled, saving time and money as well as making the city's food safer. The model uses several data sources and almost a dozen variables  that forecasts a food establishment's current risk based on real-time data. We conducted an experimental pilot to evaluate the effectiveness of the model and found it was able to accelerate the rate of finding establishments with critical violations.

# Background

`r citet(biblio["buchholz_risk-based_2002"])` built a model showing that lower inspection scores and previous violations were predictors for future foodborne incidents. While food establishments can be cited for a number of violations, foodborne illnesses were associated with food handling, temperature control, and proper storage of food `r citep(biblio[c("petran_health_2012","irwin_results_1989","kramer_neighborhood_2016")])`.

Experience and training of restaurant personnel and effective monitoring of employees are important to reduce reducing violations. Supplemental training or the presence of on-site certified kitchen managers were less likely to have outbreaks and exhibit unsafe food handling practices `r citep(biblio[c("hedberg_systematic_2006","koechlin_does_2009")])`. Likewise, studies of ethnic restaurants have found they are more likely to have foodborne illness `r citep(biblio[c("simonne_ethnic_2004", "kwon_food_2009")])`. Further investigations have found that lack of food safety information and lack of training was more prevelent among these restaurants `r citep(biblio[c("rudder_food_2006","ram_training_2000","mauer_ethnic-food_2006")])`.

One of the most critical elements to healthy restaurants is maintaining proper temperature of food. It's then reasonable to consider the impact of weather--especially extreme hot or cold temperatures--on the ability to maintain proper temperature of food. But the only study on this topic using data from San Diego did not find a relationship `r citet(biblio["rozhavskaya_association_2016"])`. However, Chicago has a greater variation in its climate and may provide a more useful data set for analysis.

There is mixed evidence on whether the frequency of inspections impacts sanitary conditions. `r citet(biblio["newbold_restaurant_2008"])` found that restaurants that were randomly assigned to less frequent inspections had higher food inspection scores. Meanwhile, a separate study showed no difference between frequency and outcomes `r citep(biblio["medu_restaurant_2017"])`. 

Finally, only limited research has looked at the context of neighborhoods on sanitation violations. `r citet(biblio["kramer_neighborhood_2016"])` looked at the level of competition from restaurants and socio-demographics of the area around restaurants. The study found that these factors had no significant impact on the propensity of finding violations. Yet, the study did not incorporate other neighborhood information, such as residential complaints of garbage and crimes, on food inspections.

## Food Inspection Protocol

CDPH mainly conducts three different types of inspections; regular canvas inspections, new license inspections, and inspections in response to a complaint. Inspections are conducted by sanitarians who are employed and trained by CDPH. Sanitarians are assigned to food establishments within a ZIP code to conduct all inspections. Sanitarians are occassionally, but infrequently reassigned.

Before a food establishment opens their doors CDPH conducts an initial new license inspection. New license inspections are coordinated with Business Affairs and Consumer Protection (BACP), who grants food establishment licenses to new establishments. Each establishment must pass this initial inspection before it is allowed to serve food to patrons. New license inspections are not used in the model because we believe that they are not characteristic of normal inspections, and because they occur when a new business applies for a license, and are therefore not schedule. 

The majority of the food inspections are regular canvas visits, which must be done on a regular basis to check the quality of sanitary conditions. The frequency of canvas inspections is driven by the risk level of the facility. Risk 1 establishments are inspected two times a year, risk 2 establishments are inspected once a year; and risk 3 restaurants are inspected every other year. The risk level is determined by the amount of direct contact that food establishment employees have with the food. For instance, establishments which only sell packaged food and sodas are placed in the third risk category.

The risk levels are determined by food handling practices required for each establishment. Restaurants and other establishments are generally categorized as risk 1 if they directly handle ingredients, prepare food, or if they cool or heat food. The lowest risk establishments generally consist of prepackaged and non-perishable food. 

The third type of inspection occurs when complaints are registered from residents, alderman, and referrals from hospitals. Complaints are received over the phone and through the web as part of Chicago's 311 system. Some complaints are also received when detected through Foodborne Chicago `r citep(biblio[[2]])`, which scans Twitter for complaints of food poisoning and encourages the respondent to submit a formal complaint.

When reporting an illness, individuals are asked to submit where they believe they contracted food poisoning, the address of the establishment, describe the symptoms and what was eaten, and when it happened. CDPH reviews the materials and may initiate a food inspection if it does seem the illness and restaurant can be linked together.

A breakdown of the inspection types in 2014:

```{r}
kable(insp_types_2014[i = TRUE,
                      list(`2014 Count` = geneorama::comma(.N)), 
                      keyby = Inspection_Type][c(insp_types_primary, "Other")], 
      align = c("l", "r"))
```

Although Risk levels help prioritize inspections by focusing on higher risk establishments, in 2014 [`r percent(risk_2014[Risk=="Risk 1 (High)",.N] / risk_2014[,.N])`] of the food establishment licenses were categorized as risk 1. The high proportion of risk 1 establishments means there is still a substantial queue to be inspected.

```{r, results='hide'}
## Originally this calculation was used for the "number of inspections per day"
## However, the risk variable is no longer in the data (since we're not using
## it in the model)
## Also, "dat" from the 30 file represented all the records that had no NA's
## over the past several years, so it would be over counting each risk class
## because it's not grouped by License
# format(round(table(dat$Risk)[3]/32/230, 0), nsmall=0)

## This is closer to the desired calculation, but the result doesn't seem right
## (I think we have fewer than 32 full time inspectors)
format(round(risk_2014_table[Risk=="Risk 1 (High)", N]/32/230, 0), nsmall=0)

## Original paragraph:
## Although Risk levels help prioritize inspections by focusing on higher risk establishments, in 2014 [`r percent(risk_2014[Risk=="Risk 1 (High)",.N] / risk_2014[,.N])`] of the food establishment licenses were categorized as risk 1. The high proportion of risk 1 establishments means there is still a substantial queue to be inspected. Yet, the work is certainly achievable. Assuming 32 inspectors, each inspector would need to complete [`r format(round(table(dat$)[3]/32/230, 0), nsmall=0)`] canvas inspections each working day---in addition to complaint-driven and new license inspections.
```


```{r, fig.width=4, fig.show='hold'}
kable(risk_2014_table_formatted, align = c("l", "r"))

## Can't make plots and tables appear side by side!!! 
## so omitting this plot

# ggplot(risk_2014) + 
#     aes(x = Risk) + 
#     labs(title=paste0('Breakdown of Food Establishments\n',
#                       'by Risk Classification\n') ) +
#     geom_bar() + 
#     # guides(fill=FALSE) +
#     # scale_y_continuous(labels = percent) +
#     xlab("") + ylab("") + theme(legend.position="none")
```

## Failing Food Inspections

There are three potential outcomes to any inspection: pass, pass with conditions, and fail. The outcome of an inspection depends on the severity of the violation and the ability to correct it. 

There are 42 different possible violations that can be cited by CDPH. These violations are classified into three categories: critical, serious, and minor violations. Critical violations consist of 14 different violations that are most likely to create conditions for foodborn illnesses, such as failure to heat food to proper temperatures or to keep items properly refrigerated at the proper temperatures. Conversely, minor violations can be as simple as leaving a rag in the sink. 

Restaurants can fail their inspections with as little as one critical violation, however serious and minor violations during an inspection can also culminate to a failed outcome. Failed inspections mean the food establishment is no longer able to operate until a follow-up inspection is conducted and demonstrates that all critical violations have been remediated.

# Model Development

The principle question is whether we can reasonably determine the probability that a restaurant inspection will yield at least one critical violation. That is, the focus will be whether or not any critical violation is found---a binary response. We mostly use publicly available data to look at the history food inspections and associate with information about the food establishment itself and also information about the neighborhood.

## Data

Historical data on food inspections for the City of Chicago are publicly available and was used from 2011 through present `r citep(biblio["city_of_chicago_food_2011"])`. It includes the name of the establishment, address, risk level, inspection date, result of the inspection, and a detailed list of each violation found during the inspection. Each violation is numbered based on severity, so each violation can be classified as critical, serious or minor. Inspections are combined with an internal, non-public list of sanitarians who conducted each food safety inspection.

Food inspection history is combined with business license data published by BACP `r citep(biblio["city_of_chicago_business_2011"])`. Any food seller must not only be licensed by the City but also obtain licenses for other activities, such as cigarette sales and liquor licenses before they can start selling such items. The license data provides other information about the business, including when certain licenses were first obtained. Business license data allows us to calculate the age of business as a proxy for staff experience and training. However, it does not contain pertinent information such as the cuisine of the establishment nor hours of operation.

We filtered the inspections to only include "retail food establishments", which excluded establishments such as schools, hospitals, and catering companies. Their inspection schedules follow a different planning process, and we also believe that these establishments have different risk characteristics that are not generalizable across the entire population. We also excluded inspection records that didn't result in an inspection because the business was closed.

Neighborhood complaints submitted through Chicago's 311 system was also used, including complaints on overflowing garbage in the neighborhood and other sanitation complaints `r citep(biblio[c("city_of_chicago_311_2011","city_of_chicago_311_2011-1")])`. Likewise, data on nearby crime was also incorporated into the analysis `r citep(biblio["city_of_chicago_crimes_2011"])`. The location of the businesses are used to calculate nearby activity. Several variables were explored, but after conduting some data mining, we settled on burglaries, sanitation code complaints, and garbage cart requests. The density of each activity was calculated and stored.

Weather data was collected from Dark Sky, which offers historical weather data for a nominal price. Daily weather information was collected for noon each day. After several conversations with CDPH staff, we focused on the relationship of temperatures and inspections. High temperatures can lead to issues to cooling food within a food establishment, which results in a critical violation. Some empirical testing of that hypothesis helped support its inclusion.

The research team conducted bi-variate analysis to identify correlation between characteristics of the food establishment, the nearby area, and whether the restaurant fails an inspection. Data was then combined into a larger statistical model and variables that lost statistical significance was omitted. Table XX shows the final set of variables used in the analysis.

```{r, eval=FALSE}
## Print the names of the coefficients / copy to clipboard
rownames(coefficients(model))
# geneorama::clipper(rownames(coefficients(model)))
```

Variable Name (Literal)                       | Variable Description
----------------------------------------------|---------------------------------
`Inspectorblue`                               | Indicator variable for Sanitarian Cluster 1
`Inspectorbrown`                              | Indicator variable for Sanitarian Cluster 2
`Inspectorgreen`                              | Indicator variable for Sanitarian Cluster 3
`Inspectororange`                             | Indicator variable for Sanitarian Cluster 4
`Inspectorpurple`                             | Indicator variable for Sanitarian Cluster 5
`Inspectoryellow`                             | Indicator variable for Sanitarian Cluster 6
`pastCritical`                                | Indicates any previous critical violations (last visit)
`pastSerious`                                 | Indicates any previous serious violations (last visit)
`timeSinceLast`                               | Elapsed time since previous inspection
`ageAtInspection`                             | Age of business license at the time of inspection
`consumption_on_premises_incidental_activity` | Presence of a license for consumption / incidental activity
`tobacco_retail_over_counter`                 | Presence of an additional license for tobacco sales
`temperatureMax`                              | The daily high temperature on the day of inspection
`heat_burglary`                               | Local intensity of recent burglaries
`heat_sanitation`                             | Local intensity of recent sanitation complaints
`heat_garbage`                                | Local intensity of recent garbage cart requests

## Risk-based model

The food inspection history is recoded into a binary outcome; whether the food estalishment passes or fails an inspection. Failure is categorized as any restaurant that has at least one critical violation. Food establishments that were not open during the inspection attempt were removed from the analysis. Otherwise, all other inspections were coded as "pass", even if it passed with condition.

We used a logistical regression to estimate the correlation between several variables and whether restaurants pass or fail. While the following form can be expressed a number of ways, the logistic form is commonly expressed as the "log-odds transformation" (Equation XX).

$$
\begin{aligned}
\log = \frac{\text{Pr}(V=1|X=x)}{\text{Pr}(V=0|X=x)} = \beta_0 + \beta^T x
\end{aligned}
$$

Thus, the objective function is to minimize 

$$
\begin{aligned}
\min_{(\beta_0, \beta) \in \mathbb{R}^{p+1}} -\left[\frac{1}{N} \sum_{i=1}^N y_i \cdot (\beta_0 + x_i^T \beta) - \log (1+e^{(\beta_0+x_i^T \beta)})\right] + \lambda \big[ (1-\alpha)||\beta||_2^2/2 + \alpha||\beta||_1\big]
\end{aligned}
$$

A review of the methods to find this solution is provided by `r citep(citation(package = "glmnet"))`, whose glmnet library for R was used to provide estimates. The `r citep(citation(package = "MASS"))` was also used in the analysis.

The past performance of food inspections was one of the leading indicators of current likelihood for a critical violation. Both critical and serious violations from the previous inspection were used as a predictor of future performance. In effect, past performance predicted future outcomes, with those with critical violations more likely to repeat those violations than even those with, at most, serious violations.

The elapsed time since the last violation was also a significant variable. The longer that it had been since an inspection the more likely the sanitarian was to find at least one critical violation. However, restaurants' scores decreased over the lifespan of the restaurant. As restaurants grow older, they are less likely to have critical violations while long time-periods between inspections increased the likelihood.

Environmental characteristics were also indicators of future performance. Trends in weather, nearby reports of burglary, and complaints about sanitation and garbage are all significant variables in the model. An increase in the moving three-day average high temperature was associated with more critical violations. In conversations with inspection managers, researchers understood this to be associated with potential mechanical failures---driven by the heat---of equipment that maintained food temperature, a main source of critical violations.

Sanitation code complaints are one of the top complaints registered with the City of Chicago through its 311 system (including web and text reports). Sanitation code complaints include several types of complaints such as overflowing garbage cans, food left outside, or litter.

The largest source of influence in the model was which sanitarian performed the inspection. We included the effect of the individual sanitarian, but we also anonymized the data to protect the individual identity of the sanitarian. Initial results with individual sanitarian coefficients were used to group the sanitarians into clusters. Those clusters were  then arbitrarily assigned color code names.  This masking had very little effect on the model performance, but makes it very difficult to tell which sanitarian performed which inspection.

A summary of the model coefficient is presented below:

```{r table_of_coefficients}
# coef_df <- data.frame(Variables = names(coef),
#                       Coefficients = coef)
knitr::kable(data.table(Variables = names(coef),
                        Coefficients = coef), 
             digits=3, 
             caption="Table of Coefficients")
# kable(as.data.frame(coef), format="html", caption="hi")
# kable(head(iris), format = "html", caption = "Title of the table")

```

## Validating and Tuning

The GLM-based approach allows us to tune the model to our preferrable level of accuracy. In this case, accuracy is not symmetrical. Figure XX shows the receiver-operator characteristic (ROC) curve that shows the trade-off between true positives and false negatives. The predictive model can be tuned to be aggressive and capture almost all potential violations, but that will also increase the rate of falsely identifying restaurants with no critical violations (also known as Type I errors). Alternatively, a conservatively tuned model will reduce false warnings (type I errors), but will increase the rate of forgoing restaurants that do have critical violations (also known as Type II errors).

[INSERT ROC GRAPH]

The Food and Drug Administration's _Food Code_ and City of Chicago ordinance and regulations continue to require that food establishments be inspected regularly. Even if a food establishment was incorrectly identified by the model (a "false positive" or Type I error), the sanitarians would still be able to complete their necessary inspections required by CDPH. Since the purpose of the statistical model is to flag critical violations, missing restaurants would undermind the overall objective.

Thus, we tuned the model to minimize "missed" predictions. The vertical line in Figure XX shows the targeted accuracy for the predictive model. Table XX shows various measures of accuracy for the predictive model. 

[INSERT CONFUSION MATRIX]



# Evaluation

After developing and tuning the statistical model to predict critical violations, the research team evaluated whether the model could optimize food inspection processes. Namely, the model is used to determine how much faster the food inspection team can discover critical violations. The team uses a simulation to compare real-life results to an alternate, data-driven arrangement.

After formulating the analytical model, the the principal question for researchers turned to whether this analytical model provides more efficiency for the food inspection team. CDPH operational procedures requires the department to inspect every risk 1 and risk 2 restaurant. Therefore, the operational goal is to allow sanitarians to discover critical violations earlier than their current operations (business-as-usual).

One approach for an evaluation may have also sought to determine if the predictive model could discover more restaurants with critical violations. Since CDPH is required to inspect every risk 1 and risk 2 restaurant, discovering more restaurants is not a pertinent goal. Instead, it serves a greater public interest to discover violations sooner, thereby, reducing the potential exposure of conditions that breed foodborne illnesses to the public.

## Evaluation Design

The analytical model was trained on data from January 2011 through January 2014. The researchers waited until CDPH completed food inspections in September and October 2014. This timeframe ensured significant time passed between the test period and the evaluation period to reduce any incidental correlation between the two periods. CDPH was not aware this timeframe would be used for an evaluation in order to prevent against a Hawthorne Effect or other bias. Again, to reduce any potential to bias within reason, senior management at CDPH was aware of on-going research, but sanitarians were not informed of the research. Finally, several months passed between model development and the evaluation period, reducing a perception of the evaluation period.

Sanitarians were assigned normally by the sanitarian manager, who was aware of the evaluation. Sanitarians were assigned to each ZIP code as normal and no workforce was reallocated for the evaluation.

The evaluation period lasted two months, from `r datTest[ , as.POSIXct(min(Inspection_Date))]` to `r datTest[ , as.POSIXct(max(Inspection_Date))]` and calculate the percentage of inspections that result in critical violations in the first half of the inspections during this period. The number of violations found during this period can be considered as status quo or current mode of operation. It serves as a baseline to capture performance levels of sanitarians, namely, the proportion and rate of critical violations that are found.

Meanwhile, we calculate the point predictions for each establishment using the training data from 2011 through 2014. The training data does not include the evaluation period so not to provide additional feedback from the evaluation period. We sort the establishments that were inspected during the evaluation in descending order of predicted values, placing the highest risk restaurants at the top of the list.

We calculate the percentage of those restaurants that would be inspected in the first half if the predictive model was used. The difference between the percentage of establishments found with critical violations during this period reflects the relative gain or loss of efficiency. Finding a greater percentage of critical violations with the predictive model indicates results can be found earlier. A similar or reduced amount indicates the predictive model provides no benefit or is less efficient, respectively.

## Results

CDPH completed `r geneorama::comma(datTest[, .N])` inspections between `r datTest[ , as.POSIXct(min(Inspection_Date))]` and `r datTest[ , as.POSIXct(max(Inspection_Date))]`. During this time, CDPH found `r datTest[ , sum(criticalFound)]` violations, `r datTest[ , paste0(round(100*(sum(criticalFound)/.N), 1), "%")]`percent of all inspections. The rate of violations is consistent with the historical average of approximately 15 percent. While the rate of violations is slightly higher, it is close enough where we do not suspect this period is abnormal, thus, a valid comparison for our evaluation.

```{r bar_graph_comparing_BAU_and_model_in_first_half, fig.show='hold', fig.width=3}
ggplot(crit_viol_rate) + 
    aes(x = Regime, y = values) + 
    labs(title=paste0('Percentage of inspections\n',
                      'resulting in a critical violation\n',
                      'during Period 1\n') ) +
    geom_bar(stat = "identity") + 
    # guides(fill=FALSE) +
    scale_y_continuous(labels = percent) +
    xlab("") + ylab("") + theme(legend.position="none")

ggplot(crit_viol_cumulative) + 
    aes(x = factor(Regime), y = values) + 
    labs(title=paste0('Percentage of period 1 & 2\n',
                      'critical violations\n',
                      'found in Period 1\n') ) +
    geom_bar(stat = "identity") +
    # guides(fill=FALSE) +
    scale_y_continuous(labels = percent) +
    xlab("") + ylab("") + expand_limits(y = 1) + theme(legend.position="none")
```

On average, food establishments were identified `r sprintf("%0.2f", mean(time_diff))` days earlier under a data-driven model. Generally, critical violations would have been found sooner under the data-driven regime. The rate of finding critical violations in the first half of the would have increased by `r paste0(sprintf("%0.1f", crit_viol_rate[,diff(values)/values[1]]*100), "%")` under the data-driven model. `r paste0(sprintf("%0.1f", crit_viol_cumulative[Regime=='Business As Usual',values]*100), "%")` of critical food violations were found in the first half; meanwhile, under the data-driven model, `r paste0(sprintf("%0.1f", crit_viol_cumulative[Regime=='Data Driven',values]*100), "%")` of all of the critical violations (an increase of `r paste0(sprintf("%0.1f", crit_viol_cumulative[,diff(values)/values[1]]*100), "%")`). 

While the average gain was `r sprintf("%0.0f", mean(time_diff))` days, there was a significant range in the change. Some restaurants were identified `r max(time_diff)` days earlier than business-as-usual. Half of the crticial violations were identified over `r quantile(time_diff)[3]` days earlier while quarter of all violations were prioritized over `r quantile(time_diff)[4]` days sooner. Yet, some restaurants would be prioritized lower, `r sum(time_diff < 0)` restaurants were incorrectly prioritized lower and were found to have critical violations later--`r paste0(sprintf("%0.0f", sum(time_diff < 0) / length(time_diff)*100), "%")` of the observed critical violations.

```{r graph_of_time_diff, fig.width=6.5, fig.height=5}
hist(as.numeric(time_diff),
#      main = paste0("Distribution of the difference \n",
#                    "in time to discover a critical violation"),
     main = paste0("During the test the data diriven approach would have \n",
                   "generally found critical violations sooner"),
     breaks = 30, 
     xlim = c(-60, 60),
     xlab = "Number of days earlier / (later) that a \ncritical violation would have been discovered",
     col = c(rep("#CC79A7", 10), rep("#009E73", 20)))
text(40, 20, "Green = Improved \n                    performance")
text(-45, 20, "Magenta = Reduced \n                        performance")
```
```{r time_diff_t-test, warning=FALSE, results='hide', message=FALSE}
time_diff_t_test <- t.test(time_diff, mu=0)
```
We conducted a t-test to measure whether the reduction in time to find a critical violation was greater than zero. Namely, the null hypothesis is the average time each food inspection was accelerated is equal to zero. The test ($\sigma =$ `r sprintf("%0.2f", sd(time_diff))`, df = `r time_diff_t_test$parameter`) resulted in a p-value of `r sprintf("%.3e", time_diff_t_test$p.value)`, which indicates that the model is extremely likely to be significant.

Below, Gini curves show the relative difference in the inspection regimes throughout the pilot. Since the first day, the data-driven model revealed more critical violations. Specifically, [111] more violations were found in the first week between September 2 and September 5 ([141] under data-driven compared to [30] for business-as-usual). The cumulative number of violations found were always higher for the data-driven approach until the final day of the pilot.

```{r}
## Create data for cumulative violation summaries
comp_summary_cumsum <- comp_summary[
    i = TRUE,
    j = list(`\nInspection Date` = Inspection_Date,
             `Business As Usual` = cumsum(Crit_Violations_BAU),
             `Data Driven` = cumsum(Crit_Violations_Model),
             `Best Possible` = cumsum(Best_Possible),
             `Worst Possible` = cumsum(Worst_Possible))]
comp_summary_cumsum_subset <- comp_summary_cumsum[
    i = TRUE, 
    j = list(`\nInspection Date`,
             `Business As Usual`,
             `Data Driven`)]
```

```{r, fig.width=10, fig.height=8}
ggplot(melt(data = comp_summary_cumsum_subset, 
            id.vars = "\nInspection Date")) +
    aes(x = `\nInspection Date`, 
        y = value, 
        colour = variable) + 
    labs(title="Comparing cumulative violations discovered\n") +
    ylab("Cumulative critical violations to date\n") +
    geom_line(lwd=1.5) + 
    geom_point(colour="black") +
    theme(legend.position="bottom")
```

By extension, the rate of finding critical violations is higher for the initial quarter of the pilot. The rate of the violations are higher in the first portion as the analytic model correctly ranks higher-risk restaurants for earlier inspection. Business-as-usual has a more consistent rate of discovery, approximately [0.2] per day and stays above [0.1] violations per day. However, whereas the data-driven model is more successful early, the rate of finding violations declines in the last quarter of the pilot.
```{r, fig.width=10, fig.height=8}
ggplot(
    melt(data = comp_summary[
        i = TRUE,
        j = list(`Business As Usual` = 
                     Crit_Violations_BAU / Total_Inspections,
                 `Data Driven` = 
                     Crit_Violations_Model / Total_Inspections),
        keyby = list(`\nInspection Date` = Inspection_Date)], 
            id.vars = "\nInspection Date")) +
    aes(x=`\nInspection Date`, y=value, colour=variable, fill=variable) + 
    labs(title=paste0('Critical violations found on a daily basis\n',
                      'as a percent of total daily inspections\n',
                      "(smoothed results)\n") ) +
     ylab("Percent of inspections resulting \n in critical violations\n") +
    theme(legend.position="bottom") +
    scale_y_continuous(labels = percent) +
    stat_smooth(method = "gam", 
                formula = y ~ s(x, k=10, sp=2, bs="ps"), 
                alpha=.3,
                level = .65)
```

The retrospective analysis allows us to surmise and compare to a "best case scenario", the most efficient order of restaurants to inspect based on their risk. In this case, we surmise the best case scenario is where every critical violation is found Below, a graph shows the difference between the most efficient path

```{r, fig.width=10, fig.height=8}
ggplot(melt(data = comp_summary_cumsum, 
            id.vars = "\nInspection Date")) +
    aes(x = `\nInspection Date`, 
        y = value, 
        colour = variable) + 
    labs(title=paste0("Comparing cumulative violations discovered\n",
                      "with additional optimal path\n")) +
    ylab("Cumulative critical violations to date\n") +
    theme(legend.position="bottom") +
    geom_line(lwd = 1.5)
```


# Summary

This model was able to reduce the timeframe to discover critical violations at Chicago's food establishments by `r sprintf("%0.2f", mean(time_diff))` days across 8 weeks. This study provides several insights on the drivers for determining restaurants failing food inspections. Consistent with prior research, food establishments with previous critical and serious violations are likely to have those violations in the future. 

Importantly, our research shows, which controlling for other factors, that differences in sanitarians significantly impact the ability to detect critical violations. Some prior research did not find sanitariants influenced the outcome of inspections, which could be a factor specific to local jurisdictions. However, this study controlled for a larger number of factors than prior studies, so we may have been able to better identify the sanitarian effect.

Warmer days also increase the chance of encountering critical violations. Chicago's climate significantly over the year and hot days may make it more difficult for food establishments to maintain proper temperature of food. Long-term studies or studies comparing inspections over time may need to consider weather at the time of inspections. 

Chicago's governance around alcohol licensing may be unique compared to other jurisdictions, but raises interesting considerations for other studies. Food establishments may serve food, but may earn revenues from other business activities that influence food operations. Unfortunately, we had limited information on precise revenues eanred by businesses so could not explore this further.

Limited research has explored the interaction between the food establishments and the surrounding neighborhood. We included reports of garbage and sanitation complaints, both where positively associated with critical violations. Likewise, we found that burglaries are also positively correlated. 

It's important to note that this study is not attempting to establish causal relationships. Food establishments likely consider the characteristics neighborhood they choose to open in and communities will evolve and be influenced by establishments like restaurants. Likewise, researchers have noted that the propensity to report complaints like garbage, sanitation, or even crimes will vary between communities.

Prior research has mixed evidence on the impact on the frequency of inspections. This study shows longer period of time between inspections will increase the likelihood of finding critical violations. But, this impact is practically small and minor compared to the other variables.

Finally, we used the age of the business as a proxy for the experience of the restaurant staff. Our findings show that older businesses are less likely to have critical violations. Again, we can only narrowly interpret the coefficient since older businesses were apparently able to compete and outlast other food establishments.

## Implementation

After the evaluation, we worked with CDPH to operationalize the model to guide the allocation of sanitarians based on the predictive model. We built a small, lightweight application that shows all establishments with a "retail food establishment" license, the location, and the estimated probability of encountering ritical violations for each food establishment.

Data is updated each day and retrained based on the most recent information on food inspection results, garbage and sanitation complaints, burglaries, and food establishments and their other licenses and history. Due to data limitations, we removed weather and sanitarian-specific information from daily predictions, however, it does not impact the order of inspections.

CDPH manager uses the application to guide the allocation of sanitarians. Because Chicago still must inspect all Risk 1 and Risk 2 food establishments, the predictions are used to guide inspections within the process of completing all _pro forma_ inspections.

While risk-based models can identify risky restaurants, departments will need to carefully implement any risk-based inspection system. Namely, restaurants may be more risky in one area of the city but not risky in other areas. But, departments should not forgo their large segments of population since it may systematically alienate segments of the population.

We worked with CDPH to align the risk-based model so their sanitarians continued to evenly service the entire city, but prioritize inspections within each ZIP code. While there theoretically be a more efficient allocation of sanitarians, this method ensure equitable service delivery for everyone.

The sanitarian had a significant impact on the probability of finding violations. Some sanitarians, while controlling for other factors for the food establishment, performed above-average and, therefore, had a higher propensity to find a violation. These results are provided to the sanitation manager to help inform her training plan for each sanitarian.

Finally, the research team has published the underlying code for the food inspection model and the calculations for the evaluation `r citep(biblio["leynes_food-inspections-evaluation:_2017"])`. Other researchers are encouraged to replicate results and to explore improvements on the existing model. Competiting models which demonstrate better performance, use readily available data, and only use open-source software can be submitted to the City of Chicago, which will use the newer code to drive the at-risk inspections.

## Limitations

Some useful data was not available for the research team. The restaurant cuisine is not reported to the city, even though some evidence suggests that ethnic restaurants comprise a growing share of foodborne illnesses `r citep(biblio["simonne_ethnic_2004"])` and the rate varied greatly within different types of ethnic restaurants `r citep(biblio[c("liu_perceptions_2008", "kwon_food_2009"])`. Likewise, we did not have access to the relative size of the restaurant despite strong indication that it's a strong predictor of future violations `r citep(biblio[c("buchholz_risk-based_2002","salas_predictors_2016")])`.

At times, we've explicitly assumed that finding violations is time invariant throughout the pilot phase. That is, a food establishment found with a critical violation on day 40 would have also been found to have a violation even if it was inspected earlier. Unfortunately, we do not have a method to test this assumption. However, the relatively short time window of the study helped ensure external factors, such as severe weather, had limited impact on temporal violations.

Additional data can also be used to supplement this model. A surge of recent research and explored the use of social media and online restaurant reviews to predict food inspection results `r citep(biblio[c("harris_health_2014", "kang_where_2013", "sadilek_nemesis:_2013")])`. These inputs are complementary to risk-based models for canvas inspections. Social media-based reports and online reviews are better-suited to help generate and respond to complaint-based inspections, which this at-risk model does not attempt to address.

## Acknowledgements

We would like to thank the food sanitation team at the Chicago Department of Public Health, in particular, Gerrin Butler who graciously and patiently worked with us. We are indebted to Stephen Collins, Ben Auberbauch, _who else?_ on the Allstate Insurance team (probably will just add them as co-authors). This research would not have been possible without the Civic Consulting Alliance, especially Alexander Sherman, _the other guys_, Brian _forgot his last name but he runs it all_. Finally, we appreciate the feedback and comments from _list people who contributed on GitHub, even the documentation stuff_.

## Supplementary Materials

The source code for the risk-based model and the evaluation described in this paper is available at `r citep(biblio["leynes_food-inspections-evaluation:_2017"])`.

# References

```{r references, echo=FALSE, message=FALSE}
geneorama::set_project_dir("food-inspections-evaluation")
write.bibtex(file="REPORTS/references.bib")
```
